{#
  Copyright (C) 2020 CERN.
  Copyright (C) 2020 Northwestern University.
  Copyright (C) 2021 Graz University of Technology.
  Copyright (C) 2021 TU Wien.
  Copyright (C) New York University.
  Copyright (C) GEO Secretariat.

  Invenio RDM Records is free software; you can redistribute it and/or modify
  it under the terms of the MIT License; see LICENSE file for more details.

  This file was adapted from the Invenio RDM Records.
#}

{%- from "invenio_app_rdm/records/macros/files.html" import preview_file %}

{% macro preview_file_box(file, pid, is_preview, record, preview_endpoint) %}
  <div class="ui accordion panel marketplace {{record.ui.access_status.id}}">
    <div class="title panel-heading {{record.ui.access_status.id}} truncated"
         tabindex="0" aria-label="{{ _('File preview') }}"
    >
      <span id="preview-file-title"><i class="eye icon"></i> File view</span>
    </div>
    <div class="active content pt-0">
      <div>
        {{ preview_file(preview_endpoint, pid_value=pid, filename=file.key, is_preview=is_preview) }}
      </div>
    </div>
  </div>
{%- endmacro %}

{%- macro file_list(files, pid, is_preview, with_preview=true, download_endpoint='invenio_app_rdm_records.record_file_download', preview_endpoint='invenio_app_rdm_records.record_file_preview') %}
  {%- set binary_sizes = not config.APP_RDM_DISPLAY_DECIMAL_FILE_SIZES %}
  <div class="ui large middle aligned divided list">
    {% for file in files %}
      {% if is_preview %}
        {%- set file_url_download = url_for(download_endpoint, pid_value=pid, filename=file.key, download=1, preview=1) %}
        {%- set file_url_preview = url_for(preview_endpoint, pid_value=pid, filename=file.key, preview=1) %}
      {% else %}
        {%- set file_url_download = url_for(download_endpoint, pid_value=pid, filename=file.key, download=1) %}
        {%- set file_url_preview = url_for(preview_endpoint, pid_value=pid, filename=file.key) %}
      {% endif %}
      {%- set file_type = file.key.split('.')[-1] %}

      <div class="item">
        <div class="content mini">
          <div class="metadata">
            <i class="file alternate outline large icon"></i>

            <div class="file-info">
              <div class="truncated file-key">
                <a href="{{ file_url_download }}">{{ file.key }}</a>
              </div>

              <small class="ui text-muted font-tiny">
                Size: {{ file.size|filesizeformat(binary=binary_sizes) }}
              </small>

              <small class="ui text-muted font-tiny">
                {{ file.checksum }}
                <div class="ui icon inline-block" data-tooltip="{{_('This is the file fingerprint (checksum), which can be used to verify the file integrity.')}}">
                  <i class="question circle checksum icon"></i>
                </div>
              </small>
            </div>
          </div>

          <div class="right floated content">
            <a class="ui basic grey mini button" href="{{ file_url_preview }}" target="preview-iframe" data-file-key="{{file.key}}"><i class="eye icon"></i> View</a>
            <a class="ui basic grey mini button" href="{{ file_url_download }}"><i class="download icon"></i> Download</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{%- endmacro %}

{% macro file_list_box(files, pid, is_preview, record, download_endpoint, preview_endpoint) %}
  {%- set binary_sizes = not config.APP_RDM_DISPLAY_DECIMAL_FILE_SIZES %}
  <div class="ui accordion panel marketplace">
    <div class="ui active content pt-0">
      {% if record.access.files == 'restricted' %}
        <div class="ui {{ record.ui.access_status.message_class }} message file-box-message">
          <i class="ui {{ record.ui.access_status.icon }} icon"></i><b>{{ record.ui.access_status.title_l10n }}</b>
          <p>{{ record.ui.access_status.description_l10n }}</p>
          {% if record.access.embargo.reason %}
            <p>{{_("Reason")}}: {{record.access.embargo.reason}}</p>
          {% endif%}
        </div>
      {% endif %}

      <div class="marketplace files custom-scroll">
        {{ file_list(files, pid, is_preview, download_endpoint=download_endpoint, preview_endpoint=preview_endpoint) }}
      </div>
    </div>
  </div>
{%- endmacro %}
